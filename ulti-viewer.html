<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/core-localstorage/core-localstorage.html">
<link rel="import" href="components/core-selection/core-selection.html">

<link rel="import" href="components/three-js/three-js.html">
<link rel="import" href="components/tween-js/tween-js.html">
<link rel="import" href="components/three-js-helpers/axis-helper.html">
<link rel="import" href="components/three-js-helpers/grid-helper.html">
<link rel="import" href="components/three-js-helpers/shadow-plane.html">
<link rel="import" href="components/three-js-helpers/mirror-plane.html">
<link rel="import" href="components/three-js-helpers/image-plane.html">
<link rel="import" href="components/three-js-helpers/dimensions/dimension-helpers.html">
<!--experimental-->
<link rel="import" href="components/three-js-helpers/dimensions/distance-helper.html">
<link rel="import" href="components/three-js-helpers/dimensions/thickness-helper.html">
<link rel="import" href="components/three-js-helpers/dimensions/diameter-helper.html">
<link rel="import" href="components/three-js-helpers/dimensions/angle-helper.html">
<link rel="import" href="components/three-js-helpers/dimensions/dimensions-helper-group.html">

<link rel="import" href="components/usco-client-deps/usco-client-deps.html">
<link rel="import" href="components/usco-asset-manager/usco-asset-manager.html">

<link rel="import" href="components/usco-xhr-store/xhr-store.html">
<link rel="import" href="components/usco-desktop-store/desktop-store.html">

<link rel="import" href="components/usco-amf-parser/amf-parser.html">
<link rel="import" href="components/usco-stl-parser/stl-parser.html">
<link rel="import" href="components/usco-obj-parser/obj-parser.html">
<link rel="import" href="components/usco-ply-parser/ply-parser.html">
<link rel="import" href="components/usco-ctm-parser/ctm-parser.html">

<link rel="import" href="view-settings.html">
<link rel="import" href="view-navigator.html">
<link rel="import" href="progress-cubic.html">
<link rel="import" href="progress-text.html">
<link rel="import" href="overlay-note.html">


<script src="components/three-js-helpers/dimensions/LeaderLineHelper3D.js"></script>
<!--<link rel="import" href="components/observe-array-items/observe-array-items.html">-->

<!--Polymer ui elements ...in doubt-->
<link rel="import" href="components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="components/paper-item/paper-item.html">
<link rel="import" href="components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="components/core-icons/core-icons.html">
<link rel="import" href="components/core-icons/social-icons.html">
<link rel="import" href="components/core-collapse/core-collapse.html">
<link rel="import" href="components/core-selector/core-selector.html">
<link rel="import" href="components/core-tooltip/core-tooltip.html">

<polymer-element name="x-trigger" extends="paper-icon-button" relative on-tap="{{toggle}}" noink>
  <template>
    <shadow></shadow>
    <content></content>
  </template>
  <script>
    Polymer({
      toggle: function() {
        if (!this.dropdown) {
          this.dropdown = this.querySelector('paper-dropdown');
        }
        this.dropdown && this.dropdown.toggle();
      }
    });
  </script>
  </polymer-element>


<polymer-element name="ulti-viewer" attributes="showAxis showIndicators"
on-mousewheel="{{onMouseWheel}}" on-DOMMouseScroll="{{onMouseWheel}}" on-dragover="{{handleDragOver}}" on-drop="{{handleDrop}}"
>
    <template>
      <link rel="stylesheet" type="text/css" href="ulti-viewer.css">
      <!--controls overlay-->
      <!--<view-settings autoRotate="{{autoRotate}}" showGrid="{{showGrid}}" showAxes="{{showAxes}}" fullScreen="{{fullScreen}}"
      showControls="{{showControls}}" showAnnotations="{{showAnnotations}}">
      </view-settings>-->
      <template if="{{showControls}}">
        <view-navigator controls="{{$.camCtrl}}" camera="{{$.cam}}" autoRotate="{{autoRotate}}"> </view-navigator>
      </template>
      
      <progress-text resources="{{resources}}">
      </progress-text>
      <!--
      <div class="resourceLoader">
        <template repeat="{{resource in resources}}">
          <ul>
            <template if="{{!resource.loaded}}">
            <li>
              {{resource.name}} Fetching: {{resource.fetchProgress}}% Parsing: {{resource.parseProgress}}%
              <input type="button" on-click="{{onReqDismissResource}}" value="Dismiss"></input>
            </li>
            </template>
          </ul>
        </template>
      </div>-->
      <core-tooltip id="options" label="Options" position="bottom">
      <x-trigger icon="settings" >
        <paper-dropdown class="open-below" halign="right">
          <div class="menu"> 
            <paper-item>
              <paper-checkbox style="padding-right:8px" for checked="{{showGrid}}"></paper-checkbox>
              Grid
            </paper-item>
            <paper-item>
              <paper-checkbox style="padding-right:8px" for checked="{{showAxes}}"></paper-checkbox>
              Axes
            </paper-item>
            <paper-item>
              <paper-checkbox style="padding-right:8px" for checked="{{showAnnotations}}"></paper-checkbox>
              Notes
            </paper-item>
            <paper-item>
              <paper-checkbox style="padding-right:8px" for checked="{{showControls}}"></paper-checkbox>
              Controls
            </paper-item>
            <paper-item>
              <paper-checkbox style="padding-right:8px" for checked="{{autoRotate}}"></paper-checkbox>
              Autorotate
            </paper-item>
          </div>
        </paper-dropdown>
      </x-trigger>
      </core-tooltip>
      
      <core-tooltip id="measures" label="Measures" position="bottom">
      <x-trigger icon="settings-ethernet" >
        <paper-dropdown class="open-below" halign="right">
          <div class="menu" > 
            <core-selector selected="{{measureType}}" valueattr="value">
              <paper-item value="" noink>
                <core-icon style="padding-right:8px" icon="clear"></core-icon>
                Nothing
              </paper-item>
              <paper-item value="distance" noink>
                <core-icon style="padding-right:8px" icon="settings-ethernet"></core-icon>
                Distance 
              </paper-item>
              <paper-item value="thickness" noink>
                <core-icon style="padding-right:8px" icon="unfold-less"></core-icon>
                Thickness 
              </paper-item>
              <paper-item value="angle" noink>
                <core-icon style="padding-right:8px" icon="query-builder"></core-icon>
                Angle
              </paper-item>
              <paper-item value="diameter" noink>
                <core-icon style="padding-right:8px" icon="social:circles-add"></core-icon>
                Diameter
              </paper-item>
              <paper-item value="note" noink>
                <core-icon style="padding-right:8px" icon="note-add"></core-icon>
                Note
              </paper-item>
              <paper-item value="leaderLine" noink>
                <core-icon style="padding-right:8px" icon="trending-neutral"></core-icon>
                LeaderLine3D
              </paper-item>
            </core-selector>
           </div>
         </paper-dropdown>
      </x-trigger>
      </core-tooltip>
      
      <!--
      <core-tooltip id="infos" label="Infos" position="bottom">
        <x-trigger icon="info-outline" >
        </x-trigger>
      </core-tooltip>-->
      
      
      <template if="{{ measureType=='measureDistance' }}">
        <div style="position:absolute;bottom:20px;left:50%;z-index:15;background:white">
          Distance between points {{ measuredDistance |Â toFixed(2) }}
        </div>
      </template>
      <template if="{{ measureType=='leaderLine' }}" id="leaderLineLabel">
        <div  style="position:absolute;right:20px;top:40%;z-index:30" >
          <span style="background: #ffd200;padding: 5px;"> some text </span>
        </div>
      </template>
      <!--<template if="{{ mode=='addNote' }}">
        <div style="position:absolute;bottom:20px;left:50%;z-index:15;background:white">
          <h1>Add Note:</h1>
          <div>
            <input type="text" placeholder="Title"></input>
          </div>
          <div>
            <input type="text" placeholder="Note"></input>
          </div>
           
        </div>
      </template>-->
      
      <!--<template if="{{selectedObject}}">
        <div style="position:absolute;top:300px;right:60px;z-index:15;" id="background-color" >
        <input type="color" value="{{selectedObject.material.color | colorConvert}}"/>
        </div>
      </template>-->
      
      <!-- measurements system test -->
      <dimensions-helper-group id="dimensions" selectedObject="{{selectedObject}}" 
      selectedMeasurement="{{measureType}}"> 
        <distance-helper  id="distHelper" selectedObject="{{selectedObject}}"> </distance-helper>
        <thickness-helper id="thickHelper" selectedObject="{{selectedObject}}"> </thickness-helper>
        <diameter-helper  id="diamHelper" selectedObject="{{selectedObject}}"> </diameter-helper>
        <angle-helper     id="angleHelper" selectedObject="{{selectedObject}}"> </angle-helper>
      </dimensions-helper-group>
      
      <!-- anotation overlay test -->
      <template if="{{selectedObject && showAnnotations}}">
        <template repeat="{{annotation,i in annotations}}">
          <template if="{{selectedObject.userData.part.id == annotation.partId}}">
            <overlay-note number="{{i}}" note="{{annotation}}"> </overlay-note>
           </template>
        </template>
      </template>
      
      <!--viewer itself-->
      <three-js id="threeJs" 
      selectedObject="{{selectedObject}}" selectedObjects="{{selectedObjects}}" highlightedObject="{{highlightedObject}}"
      on-objectpicked="{{objectSelected}}"
      >
          <three-stats id="stats" show=false channel='render'></three-stats>
          <tween-js></tween-js>
          
          <three-js-webglRenderer id="webglRenderer"></three-js-webglRenderer>
          <three-js-scene name="main" active pickable>
            <!--<three-pointLight color="0xfFfc7e" intensity=0.8 pos=[100, 150, 200] > </three-pointLight>
            <three-pointLight color="0xfcfc7e" intensity=0.5 pos=[100, -150, -200]> </three-pointLight>-->
            <three-directionalLight castShadow onlyShadow intensity=0.2 pos=[150,150,1500]>  </three-directionalLight>
            <three-hemisphereLight color="0xffffEE" gndColor="0xffffEE" pos="[0, 1200, 1500]" intensity=0.6></three-hemisphereLight>
            <three-ambientLight color="0x252525" intensity=3> </three-ambientLight>
            <shadow-plane up=[0,0,1]> </shadow-plane>
            <!--<mirror-plane up=[0,0,1]> </mirror-plane>-->
            <!--<image-plane imgUrl="http://localhost:8080/demo-data/test.png" up=[0,1,0] rot=[0,20,40]> </image-plane>-->
          </three-js-scene>
          <three-js-scene name="helpers" active>
            <template if="{{showAxes}}">
              <axis-helper up=[0,0,1]> </axis-helper>
            </template>
            <template if="{{showGrid}}">
              <grid-helper up=[0,0,1]> </grid-helper>
            </template>
            
              <template repeat="{{resource in resources}}">
                <template if="{{!resource.loaded}}">
                  <progress-cubic resource="{{resource}}"> </progress-cubic>
                </template>
              </template>
          </three-js-scene>
          
          
          <three-js-viewport name="perspective" id="perspectiveView" class="perspectiveView">
            <three-js-combinedCamera id="cam" pos=[100,50,200] defaultPos=[100,50,200] orientation="{{camOrientation}}" up=[0,0,1]></three-js-combinedCamera>
            <three-js-orbitControls id="camCtrl" cameraUp=[0,0,1] autoRotate="{{autoRotate && (!selectedObject || selectRotate)}}" autoRotateSpeed=2> </three-js-orbitControls>
          </three-js-viewport>
        </three-js>
     
     <!--advanced observation of arrays, so we can detect changes of item attributes
     within arrays-->
      <!--<observe-array-items array="{{annotations}}"
                           path=["text","title"]
                           on-array-item-changed="{{annotationsChanged}}">
      </observe-array-items>-->
     
      <!--core elements: loaders, etc-->
      <usco-client-deps> </usco-client-deps>
      <usco-asset-manager id="assetManager" logLevel="warn">
        <xhr-store> </xhr-store>
        <desktop-store> </desktop-store>

        <amf-parser> </amf-parser>
        <stl-parser> </stl-parser>
        <obj-parser> </obj-parser>
        <ply-parser> </ply-parser>
        <ctm-parser> </ctm-parser>
      </usco-asset-manager>
      
      <!--AutoSaving settings to localstorage-->
      <core-localstorage name="ultiviewer-settings-showGrid"    value="{{showGrid}}"></core-localstorage>
      <core-localstorage name="ultiviewer-settings-showAxes"    value="{{showAxes}}"></core-localstorage>
      <core-localstorage name="ultiviewer-settings-autoRotate"  value="{{autoRotate}}"></core-localstorage>    
      <core-localstorage name="ultiviewer-settings-showControls"value="{{showControls}}"></core-localstorage>
      
  </template>
  <script src="ulti-viewer.js"></script>
</polymer-element>
