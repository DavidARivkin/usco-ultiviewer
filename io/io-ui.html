<link rel="import" href="../components/polymer/polymer.html">

<script src="SceneSerializer.js"></script>
<script src="scene-parser.js"></script>
<script src="FileSaver.min.js"></script>

<polymer-element name="io-ui" attributes="selectedObject resources activeScene viewer">
  <template>
    <section>
       <tooltip-shadow-button label="save scene" value="saveScene" icon="save" on-tap="{{saveSceneHandler}}" >
       </tooltip-shadow-button>
       <tooltip-shadow-button label="load scene" value="loadScene" icon="folder-open" on-tap="{{loadSceneHandler}}" 
       style="position: absolute;left: 40px; top: 0px;">
       </tooltip-shadow-button>
       
    </section> 
  </template>
<script>
Polymer("io-ui",{
  activeScene:null,
  
  //custom element lifecycle callbacks
  ready:function(){
    this.sceneSerializer = new SceneSerializer();
    this.sceneParser     = new SceneParser();
  },
  //event handlers
  saveSceneHandler:function( event ){
    console.log("saving the scene");
    console.log("activeScene",this.activeScene);
    
    var assembly = 
      [
        {
        "id":"0",
        "children":[]
        }
      ]
    
    
    this.activeScene.traverse(function( node ){
      var isPartInstance = node.userData.part !== undefined ? true : false;
      if(isPartInstance){
        console.log("node is a part instance", node, node.userData.part.id);
        //entityId??? partId???
        var instance = {"partId":node.userData.part.id,p:null,r:null,s:null};
        instance.p = node.position.toArray();
        instance.r = node.rotation.toArray();
        instance.s = node.scale.toArray();
        
        assembly[0]["children"].push( instance );
      }
    });
    
    console.log(assembly);
    var sceneOutput = assembly;
    /*console.log("resources",this.resources);
    //var sceneOutput = this.sceneSerializer.serialize( this.activeScene );
    console.log(sceneOutput);*/
    var sceneTextOutput =  JSON.stringify( sceneOutput );
    console.log( sceneTextOutput );
    var blob = new Blob([sceneTextOutput], {type: "application/json;charset=utf-8"});
    saveAs(blob, "testScene.json");
  },
  loadSceneHandler:function( event ){
    console.log("loading the scene");
    this.viewer.clearScene("main");
    //TODO: how to integrate into asset manager ?
    //"http://localhost:8080/demo-data/testScene.json"
    
    //FIXME: remove this, this is just for testing
    var rawJson = '[{"id":"0","children":[{"partId":-679498544,"p":[0,0,7.000000476837158],"r":[0,0,0,"XYZ"],"s":[1,1,1]},{"partId":1664839928,"p":[0,0,8.000000953674316],"r":[0,0,0,"XYZ"],"s":[1,1,1]}]}]';
    var parsed = JSON.parse( rawJson );
    console.log("parsed", parsed);
    
    //FIXME: hack, for now assume only one assembly
    var assembly = parsed[0];
    
    //this.sceneParser.parse( rawJson );
  },
  //attribute change handlers
  activeSceneChanged:function(){
    //console.log("activeSceneChanged",this.activeScene);
  },
  selectedObjectChanged:function(){
    //console.log("selectedObject",this.selectedObject);
  }
});
</script>
</polymer-element>

