<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-selector/core-selector.html">

<!--FIXME: not 100% sure about library here -->
<script src='../components/js-quantities/src/quantities.js'></script>

<polymer-element name="simple-bom" attributes="selectedObject selectedObjects bom show">
  <template>
    <style>
      :host{
        position:absolute;
        top: 45px;
        right: 20px;
        z-index:15;
        background:white;
        font-size:0.8em;
      }
      
      table.dataTable {
          display: table;
          width: 100%;
      }
      
      table{
        font-size:0.9em;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-collapse: collapse;
      }
      /*table tbody, table thead
      {
          display: block;
      }
      
      table tbody 
      {
         overflow-y: auto;
         overflow-x: hidden;
         max-height: 300px;
      }
      
      table thead 
      {
        width:100%;
      }*/
      
      th{
        padding: 5px;
        min-width:50px;
      }
      td{
        overflow:auto;
        max-width:250px;
        padding: 5px;
        cursor:pointer;
      }
      tr{
        text-align: center;
        border:none;
      }
     
    .bomEntry.core-selected {
      background: #ffd200;/*EMPHASIS COLOR*/
    }
    
    .bomEntry.core-selected td{
      font-weight:bold;
    }
    
    .bomEntry:hover td{
      /*font-weight:bold;*/
      background: rgba(255, 210, 0, 0.28);
    }
    
    .bomEntryInstance{
      background: #fff;
    }
    .bomEntryInstance:hover{
      cursor: pointer;
    }
    .bomEntryInstance.core-selected{
      background: #f0f;
    }
    
    #wrapper{
      overflow-y: auto;
      overflow-x: hidden;
       max-height: 300px;
    }
    
    </style>
    <section id="wrapper">
       <!--
       FIXME: why does template if="{{show}}" break core-selector behaviour ?
       WE DO NOT want components like the bom view to update when not visible
       if="{{show}}"
       
       TODO:  correct filter & formatting, not the mess of templating we have now
       
       
        <table>
          <core-selector target="{{$.gnak}}" 
          selected="{{sdfs}}" ></core-selector>
          
          <tbody id="gnak">
            <tr class="bomEntry">
              <td>
                One
              </td>
            </tr>
            <tr class="bomEntry">
              <td>
                Two
              </td>
            </tr>
            <tr class="bomEntry">
              <td>
                Three
              </td>
            </tr>
          </tbody>
       </table>-->
    
       <core-selector target="{{$.bomEntries}}" 
        selected="{{selectedBomEntry}}"> </core-selector>
    
       <table hidden?="{{!show}}" class="dataTable">
        <thead>
          <tr>
            <template repeat="{{header in headers}}">
              <th>
                [[header |Â capitalize]]
              </th>
            </template>
          </tr>
        </thead>
       
        <tbody id="bomEntries">
         <template repeat="{{bomEntry in bom}}">
           
           <tr class="bomEntry">
            <template repeat="{{header in headers}}">
              <template if="{{header !== '_instances' && header !== 'implementations' && bomEntry.amount>=minAmount}}">
                <td>
                  {{bomEntry[header]}}
                </td>
              </template>
              <template if="{{header === '_instances' && bomEntry.amount>=minAmount}}">
                <td>
                   <ul>
                     <template repeat="{{instance, index in bomEntry._instances}}">
                      <li class="bomEntryInstance" on-mouseover="{{mouseOverHandler}}" on-tap="{{instanceTapHandler}}"
                      value="{{index}}"> {{index}} </li>
                     </template>
                   <ul>
                </td>
              </template>
              
              <template if="{{header === 'implementations' && bomEntry.amount>=minAmount}}">
                <td>
                   <ul>
                     <template repeat="{{source in keys(bomEntry.implementations) }}">
                      <!--<li class="bomEntryInstance" on-mouseover="{{mouseOverHandler}}" on-tap="{{instanceTapHandler}}"
                      value="{{index}}"> {{index}} </li>-->
                      <template if="{{source !== 'default'}}">
                        <!--ONLY display the implementation key if it is not "default"-->
                        {{source}}:{{bomEntry.implementations[source]}}
                      </template>
                      <template if="{{source === 'default'}}">
                         <!--ONLY display the implementation key if it is not "default"-->
                         {{bomEntry.implementations[source]}}
                      </template>
                     </template>
                   <ul>
                </td>
              </template>
              
            </template>
           </tr>
           
         </template>
       </tbody>
      </table>
      
    </section> 
    
  </template>
  <script>
  Polymer("simple-bom",{
    show:true,
  
    selectedBomEntry:null,
    selectedInstanceIndex:null,
    selectedBomEntryInstance:null,
    
    /**
     * headers of data to show
     * 
     * @attribute headers
     * @type array
    */
    headers:["id","name", "amount", "unit", "version", "implementations"],//"url","_instances"],
    
    /**
     * what type to display a given field as, default to text
     * 
     * @attribute types
     * @type object
    */
    types:{"amount":"number", "unit":"list"},
    /**
     * hide any entry with count lower than this
     * 
     * @attribute minAmount
     * @type float
    */
    minAmount: 1,
    
    /**
     * list of all available measurement units FIXME: move this elsewhere
     * 
     * @attribute _units
     * @type array
    */
    _units:["mm"],
    
    /*
    simple-bom
    
    - selecting a mesh in 3D view should select (in BOM view)
      * its bom entry (one row)
      * IF instances are listed, its instance
    
    - selecting MULTIPLE MESHES in 3D view should do the same as above, for all selections
    
    
    - selecting a bom entry in BOM view should:
      * select all instances   
    
    */
    //attribute change handlers
    created:function(){
      var units = Qty.getKinds();
      console.log("UNITS", units);
    },
    bomChanged:function(oldBom, newBom){
      console.log("bom changed", this.bom);
    },
    showChanged:function(oldShow, newShow){
      console.log("show bom screen changed", this.show);
      
      if(newShow){
        console.log("BOM", this.bom);
        //FIXME attempted workaround for failing core selector after 
        //this.selectedInstanceIndex = -1;
        //selected="{{selectedBomEntry}}"        
        //this.selectedBomEntry = null;
        //this.$.entrySelector.target=null;
        //this.$.entrySelector.target = this.$.bomEntries;
        
      }
    },
    selectedObjectChanged:function(oldSelection, newSelection){
      console.log("selectedObject", this.selectedObject );
      var selection = this.selectedObject;
      if(!selection || !selection.userData.part) {
        this.selectedBomEntry = -1;
        return;
      }
      var bomId = selection.userData.part.bomId;
      this.selectedBomEntry = bomId;
    },
    selectedObjectsChanged:function(oldSelObjects, newSelObjects){
      console.log("selectedObjects", this.selectedObjects );
      if(oldSelObjects){
        for(var i=0;i<oldSelObjects.length;i++)
        {
          var bla = oldSelObjects[i];
          if(bla.material) bla.material.color.setHex( bla.material._oldColor );
        }
      }
      
     if(newSelObjects){
        for(var i=0;i<newSelObjects.length;i++)
        {
          var bla = newSelObjects[i];
          if(bla.material){
            bla.material._oldColor = bla.material.color.getHex( );
            bla.material.color.setHex( 0xFF0000 );
          }
        }
      }
      
      
    },
    selectedBomEntryChanged:function(){
      //reset selectedInstance index
      this.selectedInstanceIndex = -1;
      this._makeEntryAndInstanceKey();
      console.log("selectedBomEntry", this.selectedBomEntry);
    },
    selectedInstanceIndexChanged:function(){
      this._makeEntryAndInstanceKey();
    },
    selectedBomEntryInstanceChanged:function(){
      var key = this.selectedBomEntryInstance;
      console.log("selectedBomEntryInstance", key);
      var partIndex = key[0];
      var instIndex = key[1];
      if( partIndex === null || instIndex === null ) return;
      
      
      if(! this.bom[ partIndex ] ) return;
      if( this.bom[ partIndex ]._instances.length == 0 ) return;
      
      if( instIndex == -1 ) //-1 means: select all
      {
        this.selectedObjects = this.bom[ partIndex ]._instances;
      }
      else{
        var selectionCandidate = this.bom[ partIndex ]._instances[ instIndex ];
        //if( selectionCandidate !== 
        this.selectedObject = selectionCandidate;
      }
    },
    //event handlers
    mouseOverHandler:function( e ){
    },
    instanceTapHandler:function( e, detail, sender ){
      console.log("bom entry instance tapped", e, detail, sender, sender.value);
      this.selectedInstanceIndex = sender.value;
    },
    //helpers
    _makeEntryAndInstanceKey:function(){
      this.selectedBomEntryInstance = [this.selectedBomEntry, this.selectedInstanceIndex];
    },
    //FIXME: are these needed ?
    _resetSelection:function(){
      //to reset correct selection after unbinding/hiding
      // (why is it lost in the first place ?
      
    },
    findPartOfInstance:function( instance ){
    },
    //
    keys: function(input) {
      return Object.keys(input);
    }, 
    
    formatBOMData:function(){
    
    },
    //FIXME: comes from , re use that
    capitalize: function (string) {
	    string = string.toLowerCase();
	    return string.charAt(0).toUpperCase() + string.slice(1);
    }

  });
  </script>
</polymer-element>  
